{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Form Vibes - Importa√ß√£o de Leads{% endblock %}

{% block extrastyle %}
<style>
    .dashboard-container {
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .dashboard-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .dashboard-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 16px;
    }

    .filter-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .filter-card h2 {
        color: #333;
        margin-bottom: 25px;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .date-filters {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .date-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .date-group label {
        font-size: 12px;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
    }

    .date-group input {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .date-group input:focus {
        border-color: #667eea;
        outline: none;
    }

    .quick-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .quick-filter-btn {
        padding: 10px 20px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        font-size: 14px;
    }

    .quick-filter-btn:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .quick-filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .stat-label {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .stat-value {
        font-size: 42px;
        font-weight: 700;
        color: #333;
        line-height: 1;
    }

    .stat-card:nth-child(1) .stat-value { color: #667eea; }
    .stat-card:nth-child(2) .stat-value { color: #22c55e; }
    .stat-card:nth-child(3) .stat-value { color: #fbbf24; }
    .stat-card:nth-child(4) .stat-value { color: #06b6d4; }

    /* Progress Section */
    .progress-section {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .progress-section.active {
        display: block;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .progress-header h3 {
        margin: 0;
        color: #333;
        font-size: 20px;
    }

    .progress-status {
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
    }

    .progress-status.iniciando { background: #fbbf24; color: white; }
    .progress-status.processando { background: #667eea; color: white; }
    .progress-status.concluido { background: #22c55e; color: white; }
    .progress-status.erro { background: #ef4444; color: white; }

    .progress-bar-container {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .progress-message {
        text-align: center;
        color: #666;
        margin-top: 15px;
        font-size: 14px;
    }

    .output-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        display: none;
    }

    .output-section.active {
        display: block;
    }

    .output-section pre {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 8px;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
        font-size: 13px;
        line-height: 1.6;
    }

    /* Result Section */
    .result-section {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        border-left: 5px solid #22c55e;
    }

    .result-section.active {
        display: block;
    }

    .result-section.error {
        border-left-color: #ef4444;
        background: #fef2f2;
    }

    .result-title {
        font-size: 22px;
        font-weight: bold;
        color: #22c55e;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .result-section.error .result-title {
        color: #ef4444;
    }

    .result-message {
        color: #333;
        margin-bottom: 20px;
        font-size: 16px;
    }

    .result-section.error .result-message {
        color: #991b1b;
    }

    .result-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }

    .result-stat-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: transform 0.3s;
    }

    .result-stat-card:hover {
        transform: translateY(-3px);
    }

    .result-stat-label {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .result-stat-value {
        font-size: 32px;
        font-weight: 700;
        line-height: 1;
    }

    .result-stat-card:nth-child(1) .result-stat-value { color: #667eea; }
    .result-stat-card:nth-child(2) .result-stat-value { color: #22c55e; }
    .result-stat-card:nth-child(3) .result-stat-value { color: #fbbf24; }
    .result-stat-card:nth-child(4) .result-stat-value { color: #06b6d4; }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }


    /* Alert Messages */
    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border-left: 4px solid #ef4444;
    }

    .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border-left: 4px solid #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üìã Form Vibes - Gest√£o de Leads</h1>
        <p>Importe e gerencie seus leads do formul√°rio Form Vibes</p>
    </div>

    <!-- Estat√≠sticas Atuais -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-label">Total de Leads</div>
            <div class="stat-value" id="totalLeads">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Novos Leads</div>
            <div class="stat-value" id="newLeads">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">J√° s√£o Clientes</div>
            <div class="stat-value" id="existingCustomers">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Prospects</div>
            <div class="stat-value" id="prospects">-</div>
        </div>
    </div>

    <!-- Filtros de Importa√ß√£o -->
    <div class="filter-card">
        <h2>üìÖ Filtros de Importa√ß√£o</h2>

        <div class="quick-filters">
            <button class="quick-filter-btn" onclick="setQuickFilter('today')">Hoje</button>
            <button class="quick-filter-btn" onclick="setQuickFilter('yesterday')">Ontem</button>
            <button class="quick-filter-btn active" onclick="setQuickFilter('week')">√öltima Semana</button>
            <button class="quick-filter-btn" onclick="setQuickFilter('month')">√öltimo M√™s</button>
            <button class="quick-filter-btn" onclick="setQuickFilter('all')">Todos</button>
        </div>

        <div class="date-filters">
            <div class="date-group">
                <label>Data Inicial</label>
                <input type="date" id="start_date" value="">
            </div>
            <div class="date-group">
                <label>Data Final</label>
                <input type="date" id="end_date" value="">
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-primary" onclick="startImport()" id="importBtn">
                <span>üöÄ</span>
                <span>Importar Leads</span>
            </button>
        </div>
    </div>

    <!-- Se√ß√£o de Progresso -->
    <div class="progress-section" id="progressSection">
        <div class="progress-header">
            <h3>Progresso da Importa√ß√£o</h3>
            <span class="progress-status" id="progressStatus">Iniciando</span>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%">
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <div class="progress-message" id="progressMessage">
            Preparando importa√ß√£o...
        </div>

        <div class="output-section" id="outputSection">
            <pre id="outputContent"></pre>
        </div>
    </div>

    <!-- Result Section -->
    <div class="result-section" id="resultSection">
        <div class="result-title" id="resultTitle">
            <span id="resultIcon"></span>
            <span id="resultTitleText">Importacao Concluida!</span>
        </div>
        <div class="result-message" id="resultMessage">
            <!-- Mensagem sera preenchida dinamicamente -->
        </div>
        <div class="result-stats" id="resultStats">
            <div class="result-stat-card">
                <div class="result-stat-label">Total Encontrados</div>
                <div class="result-stat-value" id="resultTotal">0</div>
            </div>
            <div class="result-stat-card">
                <div class="result-stat-label">Novos Leads</div>
                <div class="result-stat-value" id="resultNovos">0</div>
            </div>
            <div class="result-stat-card">
                <div class="result-stat-label">Ja Sao Clientes</div>
                <div class="result-stat-value" id="resultClientes">0</div>
            </div>
            <div class="result-stat-card">
                <div class="result-stat-label">Taxa de Conversao</div>
                <div class="result-stat-value" id="resultTaxa">0%</div>
            </div>
        </div>
    </div>
</div>

<script>
// Configurar datas padr√£o (√∫ltima semana)
function setDefaultDates() {
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(lastWeek.getDate() - 7);

    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
}

// Filtros r√°pidos de data
function setQuickFilter(filter) {
    const today = new Date();
    const endDate = new Date(today);
    let startDate = new Date(today);

    switch(filter) {
        case 'today':
            startDate = new Date(today);
            break;
        case 'yesterday':
            startDate.setDate(today.getDate() - 1);
            endDate.setDate(today.getDate() - 1);
            break;
        case 'week':
            startDate.setDate(today.getDate() - 7);
            break;
        case 'month':
            startDate.setMonth(today.getMonth() - 1);
            break;
        case 'all':
            startDate.setFullYear(2020);
            break;
    }

    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];

    // Atualizar bot√µes ativos
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}


// Carregar estat√≠sticas
function loadStats() {
    fetch('/importer/leads/stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalLeads').textContent = data.total_leads || 0;
            document.getElementById('newLeads').textContent = data.new_leads || 0;
            document.getElementById('existingCustomers').textContent = data.existing_customers || 0;
            document.getElementById('prospects').textContent = data.prospects || 0;
        })
        .catch(error => {
            console.error('Erro ao carregar estat√≠sticas:', error);
            document.getElementById('totalLeads').textContent = '0';
            document.getElementById('newLeads').textContent = '0';
            document.getElementById('existingCustomers').textContent = '0';
            document.getElementById('prospects').textContent = '0';
        });
}

// Iniciar importa√ß√£o
function startImport() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    // shoe_size √© ignorado - sempre importa todos os leads

    if (!startDate || !endDate) {
        alert('Por favor, selecione as datas de in√≠cio e fim');
        return;
    }

    const btn = document.getElementById('importBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> <span>Importando TODOS os leads...</span>';

    // Limpar resultado anterior
    document.getElementById('resultSection').classList.remove('active');
    document.getElementById('resultSection').classList.remove('error');
    document.getElementById('outputSection').classList.remove('active');

    // Mostrar se√ß√£o de progresso
    const progressSection = document.getElementById('progressSection');
    progressSection.classList.add('active');
    progressSection.scrollIntoView({ behavior: 'smooth' });

    // Iniciar importa√ß√£o real (sempre importa todos os n√∫meros de sapato)
    fetch('/importer/leads/import/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            start_date: startDate,
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Monitorar progresso
            monitorImportProgress(data.task_id, btn);
        } else {
            throw new Error(data.error || 'Erro ao iniciar importa√ß√£o');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        updateProgress(0, 'erro', 'Erro ao iniciar importa√ß√£o: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<span>üöÄ</span> <span>Importar Leads</span>';
    });
}

// Monitorar progresso da importa√ß√£o
function monitorImportProgress(taskId, btn) {
    const checkInterval = setInterval(() => {
        fetch(`/importer/leads/import/status/?task_id=${taskId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data.progress, data.status, data.message);

                if (data.status === 'concluido') {
                    clearInterval(checkInterval);
                    btn.disabled = false;
                    btn.innerHTML = '<span>üöÄ</span> <span>Importar Leads</span>';
                    loadStats();

                    // Esconder progresso e mostrar resultado formatado
                    document.getElementById('progressSection').classList.remove('active');
                    showSuccess(data);
                } else if (data.status === 'erro') {
                    clearInterval(checkInterval);
                    btn.disabled = false;
                    btn.innerHTML = '<span>üöÄ</span> <span>Importar Leads</span>';

                    // Esconder progresso e mostrar erro
                    document.getElementById('progressSection').classList.remove('active');
                    showError(data.error || data.message);
                }
            })
            .catch(error => {
                console.error('Erro ao verificar status:', error);
            });
    }, 1000); // Verificar a cada 1 segundo
}

// Mostrar sucesso com estat√≠sticas formatadas
function showSuccess(data) {
    const resultSection = document.getElementById('resultSection');
    resultSection.classList.add('active');
    resultSection.classList.remove('error');

    document.getElementById('resultIcon').textContent = '‚úÖ';
    document.getElementById('resultTitleText').textContent = 'Importacao Concluida com Sucesso!';
    document.getElementById('resultMessage').textContent = data.message || 'Todos os leads foram importados com sucesso.';

    // Preencher estat√≠sticas
    const stats = data.stats || {};
    document.getElementById('resultTotal').textContent = stats.total_encontrados || 0;
    document.getElementById('resultNovos').textContent = stats.novos_leads || 0;
    document.getElementById('resultClientes').textContent = stats.ja_clientes || 0;
    document.getElementById('resultTaxa').textContent = (stats.taxa_clientes || 0).toFixed(1) + '%';

    // Scroll para o resultado
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// Mostrar erro
function showError(message) {
    const resultSection = document.getElementById('resultSection');
    resultSection.classList.add('active');
    resultSection.classList.add('error');

    document.getElementById('resultIcon').textContent = '‚ùå';
    document.getElementById('resultTitleText').textContent = 'Erro na Importacao';
    document.getElementById('resultMessage').textContent = message;

    // Limpar estat√≠sticas em caso de erro
    document.getElementById('resultTotal').textContent = '-';
    document.getElementById('resultNovos').textContent = '-';
    document.getElementById('resultClientes').textContent = '-';
    document.getElementById('resultTaxa').textContent = '-';

    // Scroll para o resultado
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

// Atualizar barra de progresso
function updateProgress(percent, status, message) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
    document.getElementById('progressStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
    document.getElementById('progressStatus').className = 'progress-status ' + status;
    document.getElementById('progressMessage').textContent = message;
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    setDefaultDates();
    loadStats();
});
</script>
{% endblock %}
